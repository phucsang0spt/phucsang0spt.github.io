<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AlphaTab Tutorial</title>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/alphaTab.js"></script> -->
    <script src="core.js"></script>
    <script src="https://kit.fontawesome.com/b43f0e512e.js"></script>
    <script src="debounce.min.js"></script>
    <style type="text/css">
      body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
        margin: 0;
        padding: 0;
      }

      .at-wrap {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
      }
      .at-viewport {
        overflow-y: auto;
        max-height: 100%;
      }

      .at-main {
        pointer-events: all;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */
      }

      .at-cursor-bar:not(.range-mode) {
        /* Defines the color of the bar background when a bar is played */
        background: rgba(255, 242, 0, 0.25);
      }

      .track-bar {
        background-color: #27ae60;
        width: 1.5px;
        height: 100%;
        z-index: 2;
      }

      /* .timebar {
        position: absolute;
        background-color: #27ae60;
        width: 1.5px;
        height: 100%;
        top: 0;
        cursor: pointer;
      }

      .timebar:first-child {
        left: 0;
        transform: translateX(-100%);
      }

      .timebar:last-child {
        right: 0;
      } */

      /*
      .timebar::before {
        position: absolute;
        content: "";
        top: 0;
        left: 50%;
        width: 0px;
        height: 0px;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 8px solid #27ae60;
        border-bottom: 8px solid transparent;
        transform: translateX(calc(-50% - 0.3px));
      }
      .timebar::after {
        position: absolute;
        content: "";
        bottom: 0;
        left: 50%;
        width: 0px;
        height: 0px;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-bottom: 8px solid #27ae60;
        border-top: 8px solid transparent;
        transform: translateX(calc(-50% - 0.3px));
      }

      */
      .at-surface.highlight > div:nth-child(n + 4):nth-last-child(n + 3) {
        /* border: 2px solid rgba(56, 68, 234, 0.763); */
        background-color: #7fbafd15;
      }
      .at-selection > div {
        /* Defines the color of the selection background */
        background-color: #27ae5f69;
        position: relative;
      }

      .at-cursor-beat {
        /* Defines the beat cursor */
        background: rgba(64, 64, 255, 0.75);
        width: 3px;
      }

      .at-highlight * {
        /* Defines the color of the music symbols when they are being played (svg) */
        fill: #0078ff;
        stroke: #0078ff;
      }

      .loader {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #ffffff30;
      }
    </style>
  </head>

  <body>
    <!-- <template id="tl_timebar">
      <div class="timebar"></div>
    </template> -->
    <div class="at-wrap">
      <div class="at-viewport">
        <div class="at-main"></div>
      </div>
      <div id="loader" class="loader">
        <img src="./loading.svg" alt="" />
      </div>
    </div>

    <script type="text/javascript">
      // load elements
      const wrapper = document.querySelector(".at-wrap");
      const main = wrapper.querySelector(".at-main");
      const loader = document.getElementById("loader");
      const viewport = wrapper.querySelector(".at-viewport");

      function trackToJSON(track) {
        return {
          id: track.index,
          name: track.name,
        };
      }

      function genTrackBar() {
        const runBar = main.querySelectorAll(".at-cursor-beat")[0];
        const clone = runBar.cloneNode();
        clone.setAttribute("class", "track-bar");
        runBar.parentElement.appendChild(clone);

        return clone;
      }

      function clearPlaybackRange() {
        const sheetEngine = window.sheetEngine;
        sheetEngine.clickTrack = {};
        sheetEngine.playbackRange = null;
        // clear all bar
        const bars = main.querySelectorAll(".track-bar");
        bars.forEach((bar) => bar.remove());
      }

      function onRangeMode() {
        const atCursor = main.querySelector(".at-cursors");
        const surface = main.querySelector(".at-surface");
        window.sheetEngine.createRangeMode = true;
        surface.classList.add("highlight");
        atCursor.querySelector(".at-cursor-bar").classList.add("range-mode");
        emitEventToApp({
          event: "onRangeModeChanged",
          payload: true,
        });
      }

      function offRangeMode() {
        const atCursor = main.querySelector(".at-cursors");
        const surface = main.querySelector(".at-surface");
        window.sheetEngine.createRangeMode = false; // set flag off

        // off range mode style
        surface.classList.remove("highlight");
        atCursor.querySelector(".at-cursor-bar").classList.remove("range-mode");
        clearPlaybackRange();

        //
        emitEventToApp({
          event: "onRangeModeChanged",
          payload: false,
        });
      }

      function toggleRangeMode() {
        window.sheetEngine.pause();
        if (!window.sheetEngine.createRangeMode) {
          onRangeMode();
        } else {
          offRangeMode();
        }
      }

      function replaySheet() {
        // off range mode before reset
        offRangeMode();
        window.sheetEngine.player.timePosition = 0;
        window.sheetEngine.updateSettings();
        window.sheetEngine.render();
      }

      function toggleVolume() {
        window.sheetEngine.masterVolume = +!window.sheetEngine.masterVolume; // 1 | 0;
        emitEventToApp({
          event: "onMuteChanged",
          payload: !window.sheetEngine.masterVolume,
        });
      }

      window.emitEventToApp = window.ReactNativeWebView
        ? function (obj) {
            window.ReactNativeWebView.postMessage(
              `event::${JSON.stringify(obj)}`
            );
          }
        : function () {
            console.log("emit to app noop");
          };

      const emitOnPlayerPositionChanged = _.throttle((payload) => {
        emitEventToApp({
          event: "onPlayerPositionChanged",
          payload,
        });
      }, 10);

      async function bootstrap(data) {
        window.hashTracks = {};

        if (window.sheetEngine) {
          window.sheetEngine.stop();
          window.sheetEngine.destroyPlayer();
          window.sheetEngine = undefined;
        }
        // initialize alphatab
        const api = new alphaTab.AlphaTabApi(main, {
          file: data,
          player: {
            enablePlayer: true,
            soundFont: "./sonivox.sf2",
            scrollElement: viewport,
          },
        });
        api.settings.display.scale = 2;

        api.isLooping = true;
        api.playbackRange = null;
        api.totalTick = null;
        api.clickTrack = { left: null, right: null };
        api.createRangeMode = false;
        window.sheetEngine = api;

        api.renderStarted.on(() => {
          loader.style.display = "flex";
          emitEventToApp({
            event: "onRenderStarted",
            payload: {
              runningTracks: api.tracks.map((track) => trackToJSON(track)),
            },
          });
        });
        api.renderFinished.on(() => {
          loader.style.display = "none";
          emitEventToApp({
            event: "onRenderFinished",
            runningTracks: api.tracks.map((track) => trackToJSON(track)),
          });
        });

        //   api.countInVolume = 1;
        //   api.metronomeVolume = 1;
        //   api.isLooping = loop.classList.contains("active");

        //   api.settings.display.layoutMode = alphaTab.LayoutMode.Horizontal;
        //   api.settings.display.layoutMode = alphaTab.LayoutMode.Page;

        api.scoreLoaded.on((score) => {
          window.hashTracks = {};
          emitEventToApp({
            event: "onScoreLoaded",
            payload: {
              title: score.title,
              artist: score.artist,
              tracks: score.tracks.map((track) => {
                const obj = trackToJSON(track);
                hashTracks[obj.id] = track;
                return obj;
              }),
            },
          });
        });

        api.soundFontLoad.on((e) => {
          const percentage = Math.floor((e.loaded / e.total) * 100);
          emitEventToApp({
            event: "onSoundFontLoad",
            payload: { percentage },
          });
        });
        api.playerReady.on(() => {
          emitEventToApp({
            event: "onPlayerReady",
          });
        });

        api.playerStateChanged.on((e) => {
          emitEventToApp({
            event: "onPlayerStateChanged",
            payload: { state: e.state },
          });
        });

        api.beatMouseDown.on((e) => {
          api.clicked = true;
        });

        function handleClickLine(tick) {
          if (!api.createRangeMode) {
            return;
          }
          api.pause();

          if (!api.clickTrack.left) {
            // set left bar
            const bar = genTrackBar();
            const track = { tick, el: bar };
            api.clickTrack.left = track;
          } else {
            if (!api.clickTrack.right) {
              // set right bar
              const bar = genTrackBar();
              const track = { tick, el: bar };
              api.clickTrack.right = track;

              if (api.clickTrack.left.tick > api.clickTrack.right.tick) {
                // revert correct order
                [api.clickTrack.right.tick, api.clickTrack.left.tick] = [
                  api.clickTrack.left.tick,
                  api.clickTrack.right.tick,
                ];
              }
              // complete range
              api.playbackRange = {
                startTick: api.clickTrack.left.tick - 1,
                endTick: api.clickTrack.right.tick + 250,
              };
            } else {
              clearPlaybackRange();
            }
          }
        }

        api.playerPositionChanged.on((e) => {
          if (e.isSeek && api.clicked) {
            console.log(e);
            handleClickLine(e.currentTick);
            api.clicked = false;
          }
          emitOnPlayerPositionChanged({
            currentTime: e.currentTime,
            endTime: e.endTime,
          });
        });
      }

      const [, flag] = window.location.hash?.split("#");
      if (flag === "debug") {
        bootstrap("./canon.gp");
      }
    </script>
  </body>
</html>
